{
  "when": "2017-09-11T13:20:21-04:00", 
  "message": "SYNAPSE-1049, SYNAPSE-1050 - Improvement on message processor to drop the message after max delivery attempts", 
  "who": "vanji", 
  "changes": [
    {
      "chunks": [
        {
          "locn": "-0,0 +1,57", 
          "lines": [
            "+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n", 
            "+        <!--\n", 
            "+  ~  Licensed to the Apache Software Foundation (ASF) under one\n", 
            "+  ~  or more contributor license agreements.  See the NOTICE file\n", 
            "+  ~  distributed with this work for additional information\n", 
            "+  ~  regarding copyright ownership.  The ASF licenses this file\n", 
            "+  ~  to you under the Apache License, Version 2.0 (the\n", 
            "+  ~  \"License\"); you may not use this file except in compliance\n", 
            "+  ~  with the License.  You may obtain a copy of the License at\n", 
            "+  ~\n", 
            "+  ~   http://www.apache.org/licenses/LICENSE-2.0\n", 
            "+  ~\n", 
            "+  ~  Unless required by applicable law or agreed to in writing,\n", 
            "+  ~  software distributed under the License is distributed on an\n", 
            "+  ~   * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n", 
            "+  ~  KIND, either express or implied.  See the License for the\n", 
            "+  ~  specific language governing permissions and limitations\n", 
            "+  ~  under the License.\n", 
            "+  -->\n", 
            "+\n", 
            "+<!-- Introduction to Synapse Scheduled Message Forwarding Processor with max deliver attempt and drop the message after max deliver attempt -->\n", 
            "+\n", 
            "+<definitions xmlns=\"http://ws.apache.org/ns/synapse\">\n", 
            "+\n", 
            "+    <endpoint name=\"StockQuoteServiceEp\">\n", 
            "+        <address uri=\"http://localhost:9000/services/SimpleStockQuoteService\">\n", 
            "+            <suspendOnFailure>\n", 
            "+                <errorCodes>-1</errorCodes>\n", 
            "+                <progressionFactor>1.0</progressionFactor>\n", 
            "+            </suspendOnFailure>\n", 
            "+        </address>\n", 
            "+    </endpoint>\n", 
            "+    <sequence name=\"fault\">\n", 
            "+        <log level=\"full\">\n", 
            "+            <property name=\"MESSAGE\" value=\"Executing default 'fault' sequence\"/>\n", 
            "+            <property name=\"ERROR_CODE\" expression=\"get-property('ERROR_CODE')\"/>\n", 
            "+            <property name=\"ERROR_MESSAGE\" expression=\"get-property('ERROR_MESSAGE')\"/>\n", 
            "+        </log>\n", 
            "+        <drop/>\n", 
            "+    </sequence>\n", 
            "+    <sequence name=\"main\">\n", 
            "+        <in>\n", 
            "+            <log level=\"full\"/>\n", 
            "+            <property name=\"FORCE_SC_ACCEPTED\" value=\"true\" scope=\"axis2\"/>\n", 
            "+            <property name=\"OUT_ONLY\" value=\"true\"/>\n", 
            "+            <property name=\"target.endpoint\" value=\"StockQuoteServiceEp\"/>\n", 
            "+            <store messageStore=\"MyStore\"/>\n", 
            "+        </in>\n", 
            "+        <description>The main sequence for the message mediation</description>\n", 
            "+    </sequence>\n", 
            "+    <messageStore name=\"MyStore\"/>\n", 
            "+    <messageProcessor class=\"org.apache.synapse.message.processors.forward.ScheduledMessageForwardingProcessor\" name=\"ScheduledProcessor\" messageStore=\"MyStore\">\n", 
            "+        <parameter name=\"interval\">10000</parameter>\n", 
            "+        <parameter name=\"max.deliver.attempts\">3</parameter>\n", 
            "+        <parameter name=\"max.deliver.drop\">true</parameter>\n", 
            "+    </messageProcessor>\n", 
            "+</definitions>\n", 
            "\\ No newline at end of file\n"
          ]
        }
      ], 
      "to": "java/repository/conf/sample/synapse_sample_705.xml", 
      "from": "java/repository/conf/sample/synapse_sample_705.xml"
    }, 
    {
      "chunks": [
        {
          "locn": "-62,6 +62,9", 
          "lines": [
            "                 ScheduledMessageForwardingProcessor.PROCESSOR_INSTANCE);\n", 
            " \n", 
            "         int maxDeliverAttempts = -1;\n", 
            "+\n", 
            "+        boolean isMaxDeliverAttemptDropEnabled = false;\n", 
            "+\n", 
            "         String mdaParam = null;\n", 
            "         if (parameters != null) {\n", 
            "             mdaParam = (String) parameters.get(MessageProcessorConsents.MAX_DELIVER_ATTEMPTS);\n"
          ]
        }, 
        {
          "locn": "-75,6 +78,13", 
          "lines": [
            "                 processor.deactivate();\n", 
            "             }\n", 
            "         }\n", 
            "+        if (maxDeliverAttempts > 0 && parameters.get(ForwardingProcessorConstants.MAX_DELIVER_DROP) != null &&\n", 
            "+                parameters.get(ForwardingProcessorConstants.MAX_DELIVER_DROP).toString()\n", 
            "+                        .equalsIgnoreCase(\"true\")) {\n", 
            "+\t        //Configuration to continue the message processor even without stopping the message processor\n", 
            "+\t        // after maximum number of delivery\n", 
            "+            isMaxDeliverAttemptDropEnabled = true;\n", 
            "+        }\n", 
            " \n", 
            "         // WE do not try to process if the processor is inactive or\n", 
            "         // there is no message store attached.\n"
          ]
        }, 
        {
          "locn": "-199,7 +209,14", 
          "lines": [
            "                             if (maxDeliverAttempts > 0) {\n", 
            "                                 processor.incrementSendAttemptCount();\n", 
            "                                 if (processor.getSendAttemptCount() >= maxDeliverAttempts) {\n", 
            "-                                    deactivate(processor, messageContext, parameters);\n", 
            "+                                    if (isMaxDeliverAttemptDropEnabled) {\n", 
            "+                                        //Since explicitly enabled the message drop after max delivery attempt\n", 
            "+                                        // message has been removed and reset the delivery attempt count of the processor\n", 
            "+                                        processor.resetSentAttemptCount();\n", 
            "+                                        messageStore.poll();\n", 
            "+                                    } else {\n", 
            "+                                        deactivate(processor, messageContext, parameters);\n", 
            "+                                    }\n", 
            "                                 }\n", 
            "                             }\n", 
            "                             errorStop = true;\n"
          ]
        }
      ], 
      "to": "java/modules/core/src/main/java/org/apache/synapse/message/processors/forward/ForwardingJob.java", 
      "from": "java/modules/core/src/main/java/org/apache/synapse/message/processors/forward/ForwardingJob.java"
    }, 
    {
      "chunks": [
        {
          "locn": "-60,4 +60,9", 
          "lines": [
            "      */\n", 
            "     public static final String DEACTIVATE_SEQUENCE = \"message.processor.deactivate.sequence\";\n", 
            " \n", 
            "+    /**\n", 
            "+     * Used to determine the message drop after maximum delivery\n", 
            "+     */\n", 
            "+    public static final String MAX_DELIVER_DROP = \"max.deliver.drop\";\n", 
            "+\n", 
            " }\n"
          ]
        }
      ], 
      "to": "java/modules/core/src/main/java/org/apache/synapse/message/processors/forward/ForwardingProcessorConstants.java", 
      "from": "java/modules/core/src/main/java/org/apache/synapse/message/processors/forward/ForwardingProcessorConstants.java"
    }, 
    {
      "chunks": [
        {
          "locn": "-0,0 +1,107", 
          "lines": [
            "+<?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?>\n", 
            "+<!--\n", 
            "+  ~  Licensed to the Apache Software Foundation (ASF) under one\n", 
            "+  ~  or more contributor license agreements.  See the NOTICE file\n", 
            "+  ~  distributed with this work for additional information\n", 
            "+  ~  regarding copyright ownership.  The ASF licenses this file\n", 
            "+  ~  to you under the Apache License, Version 2.0 (the\n", 
            "+  ~  \"License\"); you may not use this file except in compliance\n", 
            "+  ~  with the License.  You may obtain a copy of the License at\n", 
            "+  ~\n", 
            "+  ~   http://www.apache.org/licenses/LICENSE-2.0\n", 
            "+  ~\n", 
            "+  ~  Unless required by applicable law or agreed to in writing,\n", 
            "+  ~  software distributed under the License is distributed on an\n", 
            "+  ~   * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n", 
            "+  ~  KIND, either express or implied.  See the License for the\n", 
            "+  ~  specific language governing permissions and limitations\n", 
            "+  ~  under the License.\n", 
            "+  -->\n", 
            "+\n", 
            "+<document>\n", 
            "+    <properties>\n", 
            "+        <title>Apache Synapse - Sample 705</title>\n", 
            "+    </properties>\n", 
            "+    <body>\n", 
            "+        <section name=\"Sample 705: Introduction to Message Forwarding Processor With Advance Parameters\">\n", 
            "+            <div class=\"xmlConf\">&lt;!-- Introduction to Message Forwarding Processor With max deliver attempt and drop\n", 
            "+                the message after max deliver attempt--&gt;\n", 
            "+                &lt;definitions xmlns=\"http://ws.apache.org/ns/synapse\"&gt;\n", 
            "+                &lt;endpoint name=\"StockQuoteServiceEp\"&gt;\n", 
            "+                &lt;address uri=\"http://localhost:9000/services/SimpleStockQuoteService\"&gt;\n", 
            "+                &lt;suspendOnFailure&gt;\n", 
            "+                &lt;errorCodes&gt;-1&lt;/errorCodes&gt;\n", 
            "+                &lt;progressionFactor&gt;1.0&lt;/progressionFactor&gt;\n", 
            "+                &lt;/suspendOnFailure&gt;\n", 
            "+                &lt;/address&gt;\n", 
            "+                &lt;/endpoint&gt;\n", 
            "+                &lt;sequence name=\"fault\"&gt;\n", 
            "+                &lt;log level=\"full\"&gt;\n", 
            "+                &lt;property name=\"MESSAGE\" value=\"Executing default 'fault' sequence\"/&gt;\n", 
            "+                &lt;property name=\"ERROR_CODE\" expression=\"get-property('ERROR_CODE')\"/&gt;\n", 
            "+                &lt;property name=\"ERROR_MESSAGE\" expression=\"get-property('ERROR_MESSAGE')\"/&gt;\n", 
            "+                &lt;/log&gt;\n", 
            "+                &lt;drop/&gt;\n", 
            "+                &lt;/sequence&gt;\n", 
            "+                &lt;sequence name=\"main\"&gt;\n", 
            "+                &lt;in&gt;\n", 
            "+                &lt;log level=\"full\"/&gt;\n", 
            "+                &lt;property name=\"FORCE_SC_ACCEPTED\" value=\"true\" scope=\"axis2\"/&gt;\n", 
            "+                &lt;property name=\"OUT_ONLY\" value=\"true\"/&gt;\n", 
            "+                &lt;property name=\"target.endpoint\" value=\"StockQuoteServiceEp\"/&gt;\n", 
            "+                &lt;store messageStore=\"MyStore\"/&gt;\n", 
            "+                &lt;/in&gt;\n", 
            "+                &lt;description&gt;The main sequence for the message mediation&lt;/description&gt;\n", 
            "+                &lt;/sequence&gt;\n", 
            "+                &lt;messageStore name=\"MyStore\"/&gt;\n", 
            "+                &lt;messageProcessor\n", 
            "+                class=\"org.apache.synapse.message.processors.forward.ScheduledMessageForwardingProcessor\"\n", 
            "+                name=\"ScheduledProcessor\" messageStore=\"MyStore\"&gt;\n", 
            "+                &lt;parameter name=\"interval\"&gt;10000&lt;/parameter&gt;\n", 
            "+                &lt;parameter name=\"max.deliver.attempts\"&gt;3&lt;/parameter&gt;\n", 
            "+                &lt;parameter name=\"max.deliver.drop\"&gt;true&lt;/parameter&gt;\n", 
            "+                &lt;/messageProcessor&gt;\n", 
            "+                &lt;/definitions&gt;\n", 
            "+            </div>\n", 
            "+            <subsection name=\"Objective\">\n", 
            "+                <p>\n", 
            "+                    Introduction to Synapse Scheduled Message Forwarding Processor with advance parameters (max deliver\n", 
            "+                    attempt and drop the message after max deliver attempt)\n", 
            "+                </p>\n", 
            "+            </subsection>\n", 
            "+            <subsection name=\"Pre-requisites\">\n", 
            "+                <p>\n", 
            "+                    <ul>\n", 
            "+                        <li>\n", 
            "+                            Start Synapse using the configuration numbered 705 (repository/conf/sample/synapse_sample_705.xml)\n", 
            "+                            <div class=\"command\">\n", 
            "+                                Unix/Linux: sh synapse.sh -sample 705<br/>\n", 
            "+                                Windows: synapse.bat -sample 705\n", 
            "+                            </div>\n", 
            "+                        </li>\n", 
            "+                    </ul>\n", 
            "+                </p>\n", 
            "+            </subsection>\n", 
            "+            <subsection name=\"Executing the Client\">\n", 
            "+                <p>\n", 
            "+                    Execute the sample client a few times with the following command.\n", 
            "+                </p>\n", 
            "+                <div class=\"command\">\n", 
            "+                    ant stockquote -Daddurl=http://localhost:9000/services/SimpleStockQuoteService -Dtrpurl=http://localhost:8280/ -Dmode=placeorder\n", 
            "+                </div>\n", 
            "+\n", 
            "+                <p>\n", 
            "+                    When you start to send request to synapse from client, you will see message forwarding processor without\n", 
            "+                    getting deactivate it keep on processing. This is due to the message will be dropped from the message store after\n", 
            "+                    the maximum number of delivery attempts are made, and the message processor will remain activated.\n", 
            "+\n", 
            "+                    \"max.deliver.drop\" parameter would have no effect when no value is specified for the Maximum Delivery Attempts parameter.\n", 
            "+                    If this parameter is disabled, the undeliverable message will not be dropped and the message processor will be deactivated.\n", 
            "+                </p>\n", 
            "+            </subsection>\n", 
            "+        </section>\n", 
            "+        <p>\n", 
            "+            <a href=\"../samples.html\">Back to Catalog</a>\n", 
            "+        </p>\n", 
            "+    </body>\n", 
            "+</document>\n"
          ]
        }
      ], 
      "to": "java/modules/documentation/src/site/xdoc/userguide/samples/sample705.xml", 
      "from": "java/modules/documentation/src/site/xdoc/userguide/samples/sample705.xml"
    }, 
    {
      "chunks": [
        {
          "locn": "-276,6 +276,7", 
          "lines": [
            "                         <li><a href=\"samples/sample702.html\">Sample 702: Introduction to Message Forwarding Processor</a></li>\n", 
            "                         <li><a href=\"samples/sample703.html\">Sample 703: Introduction to Message Resequencing Processor</a></li>\n", 
            "                         <li><a href=\"samples/sample704.html\">Sample 704: Invoke Secured Services with Scheduled Message Forwarding Processor</a></li>\n", 
            "+                        <li><a href=\"samples/sample705.html\">Sample 705: Introduction to Message Forwarding Processor With Advance Parameters</a></li>\n", 
            "                     </ul>\n", 
            "                 </p>\n", 
            "             </subsection>\n"
          ]
        }
      ], 
      "to": "java/modules/documentation/src/site/xdoc/userguide/samples.xml", 
      "from": "java/modules/documentation/src/site/xdoc/userguide/samples.xml"
    }
  ], 
  "id": "1808048"
}